name: Real API Tests

on:
  workflow_dispatch: # Ручной запуск
  schedule:
    - cron: '0 2 * * *' # Каждый день в 2:00 UTC

jobs:
  real-api-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'

    - name: Create .env file from secrets
      run: |
        cat > ClubDoorman/.env << EOF
        DOORMAN_OPENROUTER_API=${{ secrets.DOORMAN_OPENROUTER_API }}
        DOORMAN_BOT_API=${{ secrets.DOORMAN_BOT_API }}
        DOORMAN_ADMIN_CHAT=${{ secrets.DOORMAN_ADMIN_CHAT }}
        EOF
        
        # Проверяем, что файл создался (без показа содержимого)
        echo "=== Проверка .env файла ==="
        ls -la ClubDoorman/.env
        echo "=== Файл создан успешно ==="

    - name: Restore dependencies
      run: dotnet restore

    - name: Build application
      run: dotnet build --configuration Release --no-restore

    - name: Run Real API tests
      run: |
        dotnet test ClubDoorman.Test/ClubDoorman.Test.csproj \
          --filter "Category=real-api" \
          --verbosity normal \
          --logger "console;verbosity=detailed" \
          --no-restore \
          --logger "trx;LogFileName=real-api-tests.trx"

    - name: Clean up sensitive files
      if: always()
      run: |
        echo "=== Очистка чувствительных файлов ==="
        rm -f ClubDoorman/.env
        rm -f .env
        echo "=== Очистка завершена ==="

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: real-api-test-results
        path: |
          ClubDoorman.Test/TestResults/
          *.trx
        retention-days: 30 