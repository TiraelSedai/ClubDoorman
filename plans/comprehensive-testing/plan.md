# План комплексного тестирования ClubDoorman

## Цели
- Увеличить покрытие кода тестами
- Добавить E2E и интеграционные тесты для критических сценариев
- Обеспечить стабильность работы бота через автоматизированное тестирование
- Разделить тесты по категориям для оптимизации CI/CD

## Структура тестов

### 1. Unit тесты (быстрые, без AI)
- **Покрытие**: Все сервисы, хендлеры, утилиты
- **Время выполнения**: < 30 секунд
- **Запуск**: Pre-commit, CI
- **Инструменты**: Существующие TestFactories, Moq

### 2. Интеграционные тесты (средние, без AI)
- **Покрытие**: Взаимодействие между сервисами
- **Время выполнения**: < 2 минут
- **Запуск**: CI, отдельно
- **Инструменты**: FakeTelegramClient, TestFactories

### 3. E2E тесты (медленные, с AI)
- **Покрытие**: Полные пользовательские сценарии
- **Время выполнения**: 5-15 минут
- **Запуск**: Только CI или ручной запуск
- **Инструменты**: FakeTelegramClient + реальные AI сервисы

### 4. Edge-case тесты (сложные сценарии)
- **Покрытие**: Граничные случаи, race conditions, ошибки API
- **Время выполнения**: 2-5 минут
- **Запуск**: CI, отдельно
- **Инструменты**: Fault injection, специальные моки

## Критические сценарии для тестирования

### Сценарии модерации пользователей
1. **Подозрительный профиль с фото**
   - Пользователь с подозрительным именем + фото профиля
   - Проверка AI анализа фото
   - Проверка блокировки/капчи

2. **Подозрительный профиль без фото**
   - Пользователь с подозрительным именем без фото
   - Проверка текстового анализа

3. **Нормальный пользователь**
   - Проверка пропуска нормальных пользователей

### Сценарии модерации сообщений
1. **Спам сообщения**
   - Сообщения, которые должны быть заблокированы ML
   - Проверка удаления + уведомления админов

2. **Нормальные сообщения**
   - Сообщения, которые должны пройти проверку

3. **Мимикрия**
   - Сообщения, имитирующие нормальные
   - Проверка детекции мимикрии

### Сценарии кнопок и callback'ов
1. **Кнопка "Спам"**
   - Нажатие на кнопку спама
   - Проверка блокировки пользователя
   - Проверка уведомлений

2. **Кнопка "Подозрительный"**
   - Нажатие на кнопку подозрительного
   - Проверка отправки в service chat

3. **Кнопка "Одобрить"**
   - Нажатие на кнопку одобрения
   - Проверка добавления в approved users

### Сценарии капчи
1. **Показ капчи**
   - Проверка отправки капчи подозрительным пользователям

2. **Правильный ответ на капчу**
   - Проверка одобрения после правильного ответа

3. **Неправильный ответ на капчу**
   - Проверка блокировки после неправильного ответа

### Edge-case сценарии
1. **AI сервис недоступен**
   - Timeout при анализе
   - Ошибки API
   - Fallback логика

2. **Telegram API ошибки**
   - Rate limiting (429)
   - Неожиданные ответы
   - Сетевые проблемы

3. **Race conditions**
   - Пользователь пишет во время капчи
   - Одновременные callback'ы
   - Конфликты модерации

4. **Неконсистентные состояния**
   - Пользователь забанен → жмет кнопку
   - Устаревшие callback'ы
   - Проверка прав при callback'е

## Техническая реализация

### Категоризация тестов
```csharp
[TestFixture]
[Category("fast")] // Unit тесты
public class FastTests { }

[TestFixture]
[Category("integration")] // Интеграционные тесты
public class IntegrationTests { }

[TestFixture]
[Category("e2e")] // E2E тесты с AI
[Category("slow")]
public class E2ETests { }

[TestFixture]
[Category("edge")] // Edge-case тесты
[Category("slow")]
public class EdgeCaseTests { }
```

### Конфигурация для разных окружений
- **Pre-commit**: Только `fast` тесты
- **CI**: `fast` + `integration` тесты
- **Manual**: Все тесты включая `e2e`

### Mock фабрики
Создать дополнительные фабрики для:
- AI сервисов (с предустановленными ответами)
- Конфигурации (разные сценарии)
- Тестовых данных (пользователи, сообщения, фото)

## Прогресс

### Этап 1: Анализ и планирование ✅
- [x] Анализ существующих тестовых фабрик
- [x] Создание плана тестирования
- [ ] Анализ покрытия кода

### Этап 2: Unit тесты
- [ ] Дополнительные unit тесты для сервисов
- [ ] Тесты для новых компонентов
- [ ] Увеличение покрытия до 80%+

### Этап 3: Интеграционные тесты
- [ ] Тесты взаимодействия сервисов
- [ ] Тесты с FakeTelegramClient
- [ ] Тесты callback обработчиков

### Этап 4: E2E тесты
- [ ] Полные сценарии модерации
- [ ] Тесты с реальными AI сервисами
- [ ] Тесты производительности

### Этап 5: CI/CD интеграция
- [ ] Настройка категорий тестов
- [ ] Оптимизация времени выполнения
- [ ] Отчеты о покрытии

## Заметки и рекомендации

### Потенциальные проблемы
1. **AI токены**: E2E тесты могут расходовать деньги
2. **Время выполнения**: Нужно оптимизировать для CI
3. **Стабильность**: Некоторые тесты могут быть flaky

### Рекомендации
1. Использовать существующие TestFactories как основу
2. Создать MockAI сервисы для unit тестов
3. Разделить тесты по категориям для гибкости
4. Добавить retry логику для flaky тестов
5. Использовать FakeTelegramClient для изоляции

### Приоритеты
1. **Высокий**: Unit тесты для core логики
2. **Средний**: Интеграционные тесты
3. **Низкий**: E2E тесты (можно отложить) 