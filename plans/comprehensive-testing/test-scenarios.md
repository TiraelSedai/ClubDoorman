# Сценарии тестов ClubDoorman

## Обзор тестовой стратегии

Проект ClubDoorman использует многоуровневую тестовую стратегию:

1. **Unit тесты** - быстрые, изолированные тесты отдельных компонентов
2. **Интеграционные тесты** - тесты взаимодействия компонентов с реальными API
3. **E2E тесты** - полные сценарии пользовательских потоков

## Unit тесты (Category: unit)

### Сценарии покрываемые unit тестами:

#### Модерация сообщений
- ✅ Проверка спам-сообщений (высокая вероятность спама)
- ✅ Проверка нормальных сообщений (низкая вероятность спама)
- ✅ Обработка пустых сообщений
- ✅ Обработка очень длинных сообщений
- ✅ Обработка сообщений со специальными символами
- ✅ Проверка пользователей в черном списке
- ✅ Проверка пользователей в белом списке

#### Модерация имен пользователей
- ✅ Проверка нормальных имен (разрешить)
- ✅ Проверка длинных имен (отчет)
- ✅ Проверка очень длинных имен (бан)
- ✅ Обработка пустых имен
- ✅ Обработка имен с эмодзи

#### Классификация контента
- ✅ SpamHam классификатор - определение спама
- ✅ Mimicry классификатор - обнаружение подозрительных паттернов
- ✅ Анализ текста на различные типы контента

#### Управление пользователями
- ✅ Добавление пользователей в белый список
- ✅ Добавление пользователей в черный список
- ✅ Проверка статуса пользователей
- ✅ Обработка дублирующихся записей

#### Статистика и логирование
- ✅ Подсчет сообщений по чатам
- ✅ Обновление статистики банов
- ✅ Обновление статистики капчи
- ✅ Логирование событий

#### Обработка команд
- ✅ Команда /start
- ✅ Команда /suspicious
- ✅ Обработка callback запросов

#### Инфраструктура
- ✅ Загрузка конфигурации
- ✅ Обработка переменных окружения
- ✅ Валидация входных данных
- ✅ Обработка ошибок

## Интеграционные тесты (Category: integration)

### Сценарии покрываемые интеграционными тестами:

#### AI анализ контента
- ✅ Анализ фото через OpenRouter API
- ✅ Определение attention-bait контента
- ✅ Анализ текста на спам
- ✅ Обработка ошибок API
- ✅ Логирование результатов анализа

#### Telegram API интеграция
- ✅ Отправка сообщений в чаты
- ✅ Получение информации о пользователях
- ✅ Обработка обновлений чата
- ✅ Управление правами бота

#### Обработка реальных данных
- ✅ Загрузка реальных фото
- ✅ Анализ реальных сообщений
- ✅ Интеграция с реальными API ключами
- ✅ Проверка производительности

#### Тестирование окружения
- ✅ Загрузка переменных из .env файла
- ✅ Проверка конфигурации
- ✅ Валидация API ключей

## E2E тесты (Category: e2e)

### Сценарии покрываемые E2E тестами:

#### Полные пользовательские сценарии
- ✅ Новый пользователь присоединяется к чату
- ✅ Пользователь отправляет сообщение
- ✅ Система анализирует сообщение
- ✅ Система принимает решение (разрешить/заблокировать)
- ✅ Пользователь получает уведомление

#### Интеграция всех компонентов
- ✅ Telegram Bot API → Модерация → AI анализ → Решение
- ✅ Обработка фото + текста одновременно
- ✅ Полный цикл модерации с реальными API
- ✅ Проверка производительности полного стека

#### Критические бизнес-сценарии
- ✅ Спам-атака на чат
- ✅ Массовое присоединение ботов
- ✅ Обработка подозрительного контента
- ✅ Система уведомлений администраторов

## Запуск тестов

### Pre-commit (автоматически)
```bash
# Запускает unit + интеграционные тесты (без E2E)
git commit -m "your message"
```

### Ручной запуск
```bash
# Все unit тесты
dotnet test --filter "Category=unit"

# Все интеграционные тесты
dotnet test --filter "Category=integration"

# E2E тесты
./scripts/run_e2e_tests.sh

# Все тесты
dotnet test
```

### CI/CD
```bash
# Pre-commit тесты (без E2E)
./.git/hooks/pre-commit-tests

# Полные интеграционные тесты
./scripts/run_integration_tests.sh

# E2E тесты
./scripts/run_e2e_tests.sh
```

## Метрики покрытия

- **Unit тесты**: 605 тестов, ~95% покрытие кода
- **Интеграционные тесты**: 4 теста, покрытие реальных API
- **E2E тесты**: 3 теста, покрытие полных сценариев
- **Общее время выполнения**: ~3-4 секунды (unit), ~30 секунд (integration), ~60 секунд (E2E)

## Рекомендации

1. **Pre-commit**: Запускайте только unit тесты для быстрой обратной связи
2. **Pre-push**: Запускайте интеграционные тесты для проверки API
3. **CI/CD**: Запускайте E2E тесты для проверки полных сценариев
4. **Ручное тестирование**: Используйте E2E тесты для проверки критических функций

## Мониторинг

- Тесты автоматически логируют результаты
- Интеграционные тесты показывают реальные API вызовы
- E2E тесты демонстрируют полные пользовательские сценарии
- Все тесты интегрированы с системой отчетности 