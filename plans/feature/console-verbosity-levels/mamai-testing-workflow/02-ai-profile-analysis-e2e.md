# Issue: [E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π](https://github.com/momai/ClubDoorman/issues/61)

## –û–ø–∏—Å–∞–Ω–∏–µ
–°–æ–∑–¥–∞–Ω–∏–µ E2E —Ç–µ—Å—Ç–æ–≤ –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–æ–∫–æ–≤ FakeTelegram.

## –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
- AI –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∞ (ü•∞ —Å–≤–æ–π, ü§ñ –±–∞–Ω, üò∂ –ø—Ä–æ–ø—É—Å–∫)
- –†–∞–±–æ—Ç–∞ –≤ –∫–∞–Ω–∞–ª–∞—Ö (–±–µ–∑ –∫–∞–ø—á–∏)
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ AI –∞–Ω–∞–ª–∏–∑–∞
- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –∞–¥–º–∏–Ω—Å–∫–∏–π —á–∞—Ç

## –ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã
- `ClubDoorman/Services/AiChecks.cs`
- `ClubDoorman/Handlers/CallbackQueryHandler.cs`
- `ClubDoorman/Models/SuspiciousUserInfo.cs`
- `ClubDoorman.Test/Integration/AiAnalysisTests.cs`

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–æ–∫–æ–≤ `MockTelegram`
- –ú–æ–∫–∏ –¥–ª—è AI —Å–µ—Ä–≤–∏—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –∫–Ω–æ–ø–æ–∫

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π
## –û—Ü–µ–Ω–∫–∞: 1 –¥–µ–Ω—å 

## –°—Ç–∞—Ç—É—Å: ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ (90%)

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

#### ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
1. **–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ E2E —Ç–µ—Å—Ç–æ–≤** –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π
   - –ù–æ–≤—ã–π —Ñ–∞–π–ª `AiAnalysisTests.cs` —Å 8 –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã Step Definitions –≤ `AiAnalysisSteps.cs`
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ using –¥–∏—Ä–µ–∫—Ç–∏–≤—ã –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏

2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å .env —Ñ–∞–π–ª–∞–º–∏ –∏ GitHub secrets:**
   - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `FindEnvFile()` –¥–ª—è –ø–æ–∏—Å–∫–∞ .env —Ñ–∞–π–ª–æ–≤ –ø–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º –ø—É—Ç—è–º
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `DOORMAN_OPENROUTER_API`, `DOORMAN_BOT_API`, `DOORMAN_ADMIN_CHAT`
   - –°–æ–∑–¥–∞–Ω GitHub Actions workflow `.github/workflows/e2e-tests.yml`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –∏–∑ repository secrets

3. **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (8 —Ç–µ—Å—Ç–æ–≤):**
   - ‚úÖ E2E_AI_Analysis_FirstMessage_ShouldTriggerAnalysis - AI –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
   - ‚úÖ E2E_AI_Analysis_AdminButton_Own_ShouldApproveUser - –ö–Ω–æ–ø–∫–∞ "ü•∞ —Å–≤–æ–π"
   - ‚úÖ E2E_AI_Analysis_AdminButton_Ban_ShouldBanUser - –ö–Ω–æ–ø–∫–∞ "ü§ñ –±–∞–Ω"
   - ‚úÖ E2E_AI_Analysis_AdminButton_Skip_ShouldSkipUser - –ö–Ω–æ–ø–∫–∞ "üò∂ –ø—Ä–æ–ø—É—Å–∫"
   - ‚úÖ E2E_AI_Analysis_Channel_ShouldNotShowCaptcha - –°–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞–Ω–∞–ª–∞—Ö
   - ‚úÖ E2E_AI_Analysis_RepeatedMessage_ShouldNotTriggerAnalysis - –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   - ‚úÖ E2E_AI_Analysis_OperationOrder_ShouldBeCorrect - –ü–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π
   - ‚úÖ E2E_AI_Analysis_PhotoWithCaption_ShouldIncludePhoto - –§–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—è–º–∏

4. **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:**
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–∏–ø–∞–º–∏ (IAppConfig vs AppConfig)
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å MessageId (readonly —Å–≤–æ–π—Å—Ç–≤–∞)
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –º–µ—Ç–æ–¥–∞–º–∏ ApprovedUsersStorage
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ using –¥–∏—Ä–µ–∫—Ç–∏–≤—ã
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DotNetEnv –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### ‚ö†Ô∏è –¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. **AI API –æ—à–∏–±–∫–∏** - —Ç–µ—Å—Ç—ã –ø–æ–ª—É—á–∞—é—Ç 401 Unauthorized –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π AI API
   - ‚úÖ **.env —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
   - ‚úÖ **API –∫–ª—é—á–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ AiChecks** - –≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö "AI –∞–Ω–∞–ª–∏–∑ –í–ö–õ–Æ–ß–ï–ù: OpenRouter API –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
   - ‚ö†Ô∏è **API –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –∏—Å—Ç–µ–∫** - –ø–æ–ª—É—á–∞–µ–º 401 Unauthorized –æ—Ç OpenRouter
2. **–õ–æ–≥–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å API –æ—à–∏–±–∫–∞–º–∏

#### üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:
- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:** 8
- **–£—Å–ø–µ—à–Ω–æ:** 1 (12.5%) ‚úÖ
- **–°–±–æ–µ–≤:** 7 (87.5%) ‚ö†Ô∏è
- **–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:** AI API –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (401 Unauthorized)
- **–°—Ç–∞—Ç—É—Å:** .env —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, API –∫–ª—é—á–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ AiChecks

#### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –æ—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ .env —Ñ–∞–π–ª–æ–≤ —Å –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GitHub secrets —á–µ—Ä–µ–∑ workflow
- ‚úÖ –°–æ–∑–¥–∞–Ω GitHub Actions workflow –¥–ª—è E2E —Ç–µ—Å—Ç–æ–≤
- ‚úÖ –£–¥–∞–ª–µ–Ω —Ñ–∞–π–ª —Å —ç–∫—Å–ø–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω .gitleaks.toml –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ API –æ—à–∏–±–æ–∫
- ‚úÖ **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ .env —Ñ–∞–π–ª–æ–≤** - API –∫–ª—é—á–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ

#### üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:
- **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:** 100% –≥–æ—Ç–æ–≤–∞
- **–¢–µ—Å—Ç—ã:** 90% –≥–æ—Ç–æ–≤—ã (—Ç—Ä–µ–±—É—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ API –∫–ª—é—á–∏)
- **CI/CD:** 100% –≥–æ—Ç–æ–≤ (GitHub Actions workflow —Å–æ–∑–¥–∞–Ω)
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** 100% (secrets —á–µ—Ä–µ–∑ GitHub, .env —Ñ–∞–π–ª—ã –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ –∫–æ–º–º–∏—Ç–æ–≤)