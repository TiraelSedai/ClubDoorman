# План диагностики неработающих кнопок

## Цель
Найти и исправить неработающие кнопки в системе, особенно в контексте мимикрии.

## Известная информация
- Кнопки не работают в системе мимикрии
- Проблема повторяется ("уже было такое")
- В других AI анализаторах кнопки работают
- Попытка параметризации привела к "хуйне"

## Этап 1: Поиск проблемных мест

### 1.1 Анализ системы мимикрии
- [ ] Найти код, связанный с мимикрией
- [ ] Определить, где создаются кнопки для мимикрии
- [ ] Проверить формат callback data для кнопок мимикрии

### 1.2 Сравнение с работающими кнопками
- [ ] Найти работающие кнопки в других AI анализаторах
- [ ] Сравнить форматы callback data
- [ ] Найти различия в обработке

### 1.3 Анализ обработчика callback
- [ ] Проверить метод `HandleAdminCallback` в `CallbackQueryHandler`
- [ ] Найти, какие форматы callback data обрабатываются
- [ ] Определить, какие форматы игнорируются

## Этап 2: Создание тестов для воспроизведения

### 2.1 Тест для кнопок мимикрии
```csharp
// Нужно создать тест, который:
// 1. Создает сообщение с кнопками мимикрии
// 2. Симулирует нажатие на кнопку
// 3. Проверяет, что действие выполнилось
```

### 2.2 Тест для сравнения с работающими кнопками
```csharp
// Тест, который сравнивает:
// 1. Работающие кнопки (например, обычный бан)
// 2. Неработающие кнопки (мимикрия)
// 3. Находит различия в обработке
```

## Этап 3: Диагностика конкретных проблем

### 3.1 Проверка форматов callback data
Возможные проблемы:
- [ ] Неправильный формат callback data
- [ ] Отсутствие обработки в `HandleAdminCallback`
- [ ] Ошибка в парсинге параметров

### 3.2 Проверка логики обработки
Возможные проблемы:
- [ ] Условие не срабатывает в switch/case
- [ ] Ошибка в парсинге long значений
- [ ] Неправильное количество параметров

### 3.3 Проверка кэширования
Возможные проблемы:
- [ ] Сообщение не сохраняется в кэше
- [ ] Неправильный ключ кэша
- [ ] Истечение времени кэша

## Этап 4: Поиск в коде

### 4.1 Поиск кнопок мимикрии
```bash
grep -r "mimicry" ClubDoorman/
grep -r "suspicious" ClubDoorman/
```

### 4.2 Поиск создания кнопок
```bash
grep -r "InlineKeyboardButton" ClubDoorman/ | grep -i "ban"
grep -r "CallbackData" ClubDoorman/
```

### 4.3 Поиск обработки callback
```bash
grep -r "HandleAdminCallback" ClubDoorman/
grep -r "suspicious.*ban" ClubDoorman/
```

## Этап 5: Анализ различий

### 5.1 Сравнение форматов
Работающие кнопки:
- `ban_{chatId}_{userId}` - обычный бан
- `banprofile_{chatId}_{userId}` - бан по профилю

Неработающие кнопки (предположительно):
- `suspicious_ban_{userId}_{chatId}_{messageId}` - бан подозрительного

### 5.2 Анализ обработки
В `HandleAdminCallback`:
```csharp
else if (split.Count > 2 && split[0] == "suspicious")
{
    await HandleSuspiciousUserCallback(callbackQuery, split, cancellationToken);
}
```

Проблема может быть в:
- [ ] Количестве параметров (split.Count > 2)
- [ ] Порядке параметров в `suspicious_ban_{userId}_{chatId}_{messageId}`
- [ ] Логике в `HandleSuspiciousUserCallback`

## Этап 6: Создание минимального теста

### 6.1 Тест для воспроизведения
```csharp
[Test]
public async Task MimicryButton_ShouldWork()
{
    // Arrange
    var callbackData = "suspicious_ban_123456789_-1001234567890_42";
    var callbackQuery = CreateCallbackQuery(callbackData);
    
    // Act
    await _handler.HandleAsync(callbackQuery);
    
    // Assert
    // Проверить, что действие выполнилось
}
```

### 6.2 Тест для сравнения
```csharp
[Test]
public async Task CompareWorkingAndNonWorkingButtons()
{
    // Arrange
    var workingCallback = "ban_-1001234567890_123456789";
    var nonWorkingCallback = "suspicious_ban_123456789_-1001234567890_42";
    
    // Act & Assert
    // Сравнить обработку
}
```

## Этап 7: План исправления

### 7.1 Минимальное исправление
- [ ] Найти точную причину неработающих кнопок
- [ ] Исправить обработку в `HandleAdminCallback`
- [ ] Добавить тесты для проверки

### 7.2 Проверка исправления
- [ ] Запустить все 515 тестов
- [ ] Протестировать в реальных условиях
- [ ] Убедиться, что кнопки работают

## Следующие шаги

1. **Начать с поиска в коде** - найти где создаются кнопки мимикрии
2. **Создать тест для воспроизведения** - точно определить проблему
3. **Сравнить с работающими кнопками** - найти различия
4. **Исправить обработку** - восстановить работоспособность
5. **Протестировать** - убедиться в исправлении 