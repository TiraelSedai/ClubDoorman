# Анализ архитектуры кнопок в ClubDoorman

## Текущая реализация

### 1. Единый обработчик callback query
- **Файл**: `ClubDoorman/Handlers/CallbackQueryHandler.cs`
- **Интерфейс**: `ICallbackQueryHandler`
- **Принцип**: Один класс обрабатывает ВСЕ callback query в системе

### 2. Типы кнопок и их callback data

#### Капча (Captcha)
- **Формат**: `cap_{userId}_{chosenIndex}`
- **Пример**: `cap_123456789_2`
- **Обработка**: `HandleCaptchaCallback()`
- **Логика**: Проверка правильности ответа на капчу

#### Админские кнопки

##### Бан пользователя (обычный)
- **Формат**: `ban_{chatId}_{userId}`
- **Пример**: `ban_-1001234567890_123456789`
- **Обработка**: `HandleBanUser()`
- **Логика**: Бан + добавление сообщения в автобан + очистка из всех списков

##### Бан пользователя (по профилю)
- **Формат**: `banprofile_{chatId}_{userId}`
- **Пример**: `banprofile_-1001234567890_123456789`
- **Обработка**: `HandleBanUserByProfile()`
- **Логика**: Бан + НЕ добавление в автобан (проблема в профиле) + очистка из всех списков

##### Одобрение пользователя
- **Формат**: `approve_{userId}`
- **Пример**: `approve_123456789`
- **Обработка**: `HandleApproveUser()`
- **Логика**: Глобальное одобрение пользователя

##### AI OK (старый формат)
- **Формат**: `aiOk_{userId}`
- **Пример**: `aiOk_123456789`
- **Обработка**: `HandleAiOkUser()`
- **Логика**: Только кэширование AI проверки

##### AI OK (новый формат)
- **Формат**: `aiOk_{chatId}_{userId}`
- **Пример**: `aiOk_-1001234567890_123456789`
- **Обработка**: `HandleAiOkUser()`
- **Логика**: Кэширование + снятие ограничений

##### Подозрительные пользователи
- **Формат**: `suspicious_{action}_{userId}_{chatId}_{messageId}`
- **Примеры**: 
  - `suspicious_approve_123456789_-1001234567890_42`
  - `suspicious_ban_123456789_-1001234567890_42`
  - `suspicious_ai_123456789_-1001234567890_42`
- **Обработка**: `HandleSuspiciousUserCallback()`
- **Логика**: Разные действия в зависимости от action

##### Пустая операция
- **Формат**: `noop`
- **Обработка**: Простое удаление кнопок

### 3. Места создания кнопок

#### MessageHandler.cs
- **Кнопки**: бан, пропуск, одобрение
- **Формат**: `ban_{chatId}_{userId}`, `noop`, `approve_{userId}`
- **Контекст**: Автобан сообщений

#### ModerationService.cs
- **Кнопки**: одобрить, забанить, AI анализ
- **Формат**: `suspicious_approve_{userId}_{chatId}_{messageId}`, `suspicious_ban_{userId}_{chatId}_{messageId}`, `suspicious_ai_{userId}_{chatId}_{messageId}`
- **Контекст**: Подозрительные пользователи

#### ServiceChatDispatcher.cs
- **Кнопки**: различные для разных типов уведомлений
- **Формат**: Разные в зависимости от типа уведомления
- **Контекст**: Админские уведомления

#### CaptchaService.cs
- **Кнопки**: кнопки капчи
- **Формат**: `cap_{userId}_{chosenIndex}`
- **Контекст**: Капча для новых пользователей

## КРИТИЧЕСКАЯ ПРОБЛЕМА: Неработающие кнопки

### Описание проблемы
- **Кнопки не работают** в некоторых контекстах (особенно в системе мимикрии)
- **Проблема повторяется** - "уже было такое"
- **Влияет на функциональность** - пользователи не могут выполнять действия через кнопки

### Причина проблемы
Согласно обсуждению пользователей:

1. **Разные форматы кнопок** для одного и того же действия (бан)
2. **Параметризация поведения** в зависимости от контекста вызова
3. **Исключения из стандартной схемы**:
   - Обычный бан: добавляет сообщение в автобан + в датасет
   - Бан за профиль/мимикрию: НЕ добавляет в автобан (проблема в профиле, не в сообщении)
   - При мимикрии: сообщения типа "привет" не должны попадать в автобан

### Конкретные проблемы
1. **Кнопка бан по умолчанию** добавляет сообщение в список авто-бана
2. **При бане за профиль/мимикрию** этого происходить не должно
3. **Сообщения типа "привет"** при мимикрии попадают в автобан и блокируют нормальные сообщения
4. **Попытка параметризации** привела к "хуйне" и неработающим кнопкам

## Анализ архитектуры

### Плюсы текущего подхода
1. **Единая точка обработки**: Все callback query обрабатываются в одном месте
2. **Простота**: Легко понять, где что обрабатывается
3. **Централизованное логирование**: Все callback логируются в одном месте
4. **Единообразная обработка ошибок**: Общая логика обработки исключений

### Минусы текущего подхода
1. **Монолитность**: Один большой класс обрабатывает все
2. **Дублирование логики**: Похожие действия (бан, одобрение) дублируются в разных методах
3. **Сложность расширения**: Добавление новых типов кнопок требует изменения основного класса
4. **Нарушение SRP**: Один класс отвечает за слишком много разных типов обработки
5. **Сложность тестирования**: Большой класс сложнее тестировать
6. **Неработающие кнопки**: Проблемы с параметризацией поведения

### Проблемы с текущим подходом

#### 1. Дублирование логики бана
- `HandleBanUser()` - бан обычного пользователя
- `HandleBanUserByProfile()` - бан по профилю (почти идентично)
- `HandleSuspiciousUserCallback()` с action="ban" - бан подозрительного пользователя

#### 2. Разные форматы для похожих действий
- `ban_{chatId}_{userId}` - обычный бан
- `banprofile_{chatId}_{userId}` - бан по профилю
- `suspicious_ban_{userId}_{chatId}_{messageId}` - бан подозрительного

#### 3. Смешивание логики
- В одном классе обрабатываются капча, админские действия, подозрительные пользователи

#### 4. Проблемы с параметризацией
- Попытка сделать одну кнопку с параметрами привела к неработающим кнопкам
- Сложность определения контекста вызова кнопки

## Возможные улучшения

### Вариант 1: Единая кнопка с параметрами (ПРОБЛЕМНЫЙ)
```csharp
// Единый формат для всех действий
"action_{actionType}_{context}_{parameters}"

// Примеры:
"action_ban_user_123456789_-1001234567890"
"action_ban_profile_123456789_-1001234567890"
"action_approve_user_123456789"
"action_ai_ok_123456789_-1001234567890"

// ПРОБЛЕМА: Уже пытались, получилась "хуйня"
```

### Вариант 2: Разделение по контекстам
```csharp
// Разные префиксы для разных контекстов
"captcha_{userId}_{chosenIndex}"
"admin_{action}_{parameters}"
"suspicious_{action}_{parameters}"
```

### Вариант 3: Стратегия обработчиков
```csharp
// Отдельные обработчики для каждого типа
ICallbackHandler
├── CaptchaCallbackHandler
├── AdminCallbackHandler
├── SuspiciousUserCallbackHandler
└── AiCallbackHandler
```

### Вариант 4: Конструктор кнопок с контекстом
```csharp
// Единая кнопка бан с параметром контекста
"ban_{chatId}_{userId}_{context}"

// Примеры:
"ban_-1001234567890_123456789_message"  // обычный бан сообщения
"ban_-1001234567890_123456789_profile"  // бан за профиль
"ban_-1001234567890_123456789_mimicry"  // бан за мимикрию
```

## Рекомендации

### Краткосрочные улучшения (КРИТИЧНО)
1. **Исправить неработающие кнопки** - приоритет #1
2. **Унифицировать форматы callback data** для похожих действий
3. **Вынести общую логику** в отдельные методы (бан, одобрение)
4. **Добавить валидацию** callback data на уровне парсинга

### Долгосрочные улучшения
1. **Разделить обработчики** по контекстам
2. **Создать фабрику обработчиков** для разных типов callback
3. **Добавить middleware** для логирования и обработки ошибок
4. **Создать отдельные сервисы** для каждого типа действий

## Вопросы для обсуждения

1. **Как исправить неработающие кнопки** в кратчайшие сроки?
2. **Нужна ли унификация форматов** callback data?
3. **Стоит ли разделять обработчики** по контекстам?
4. **Как обрабатывать общую логику** (бан, одобрение) в разных контекстах?
5. **Нужна ли фабрика обработчиков** или достаточно текущего подхода?
6. **Как правильно параметризовать** поведение кнопок в зависимости от контекста? 