# language: ru
@ignore
Feature: Система обнаружения подозрительных пользователей
  Как модератор чата
  Я хочу автоматически обнаруживать подозрительных пользователей на основе анализа их поведения
  Чтобы выявлять спамеров-хамелеонов и улучшить качество модерации

  Background:
    Given система обнаружения подозрительных пользователей включена
    And порог мимикрии установлен в 0.7
    And для одобрения подозрительного пользователя требуется 3 дополнительных сообщения

  @mimicry_detection
  Scenario: Обнаружение подозрительного пользователя по мимикрии
    Given пользователь с ID 123456789 отправляет первые 3 сообщения
    And сообщения содержат шаблонные фразы "привет", "как дела", "?"
    When система анализирует мимикрию пользователя
    Then оценка мимикрии должна быть выше 0.7
    And пользователь должен быть помечен как подозрительный
    And должна быть создана запись в хранилище подозрительных пользователей
    And администраторы должны получить уведомление о подозрительном пользователе

  @normal_user_approval
  Scenario: Обычный пользователь не помечается как подозрительный
    Given пользователь с ID 123456789 отправляет первые 3 сообщения
    And сообщения содержат естественные фразы "Привет всем! Как дела?", "Спасибо, все хорошо", "Отличная группа!"
    When система анализирует мимикрию пользователя
    Then оценка мимикрии должна быть ниже 0.7
    And пользователь должен быть одобрен как обычный
    And пользователь не должен быть помечен как подозрительный

  @suspicious_user_approval_process
  Scenario: Процесс одобрения подозрительного пользователя
    Given пользователь помечен как подозрительный
    And пользователь отправляет первое дополнительное сообщение
    When система обрабатывает сообщение подозрительного пользователя
    Then счетчик сообщений должен увеличиться до 1
    And пользователь не должен быть одобрен
    And сообщение должно пройти обычную модерацию

  @suspicious_user_final_approval
  Scenario: Финальное одобрение подозрительного пользователя
    Given пользователь помечен как подозрительный
    And пользователь отправил 2 дополнительных хороших сообщения
    When пользователь отправляет третье дополнительное сообщение
    Then счетчик сообщений должен достичь 3
    And пользователь должен быть одобрен
    And пользователь должен быть удален из списка подозрительных
    And предупреждения должны быть очищены

  @ai_detection_enable
  Scenario: Включение AI детекта для подозрительного пользователя
    Given пользователь помечен как подозрительный
    And администратор нажимает кнопку "AI анализ вкл/выкл"
    When система обрабатывает включение AI детекта
    Then AI детект должен быть включен для пользователя
    And следующее сообщение пользователя должно пройти AI анализ
    And система должна залогировать включение AI детекта

  @ai_detection_high_confidence
  Scenario: AI детект с высокой уверенностью в спаме
    Given AI детект включен для подозрительного пользователя
    And пользователь отправляет сообщение с высокой вероятностью спама
    When система выполняет AI анализ
    Then AI должен определить высокую вероятность спама (>0.8)
    And сообщение должно быть автоматически удалено
    And должно быть отправлено уведомление "AI детект: автоудаление спама"
    And AI детект должен быть выключен после анализа

  @ai_detection_uncertain
  Scenario: AI детект с неопределенным результатом
    Given AI детект включен для подозрительного пользователя
    And пользователь отправляет сообщение с неопределенной вероятностью спама
    When система выполняет AI анализ
    Then AI должен определить среднюю вероятность спама (0.3-0.7)
    And пользователь должен быть ограничен на 2 часа
    And должно быть отправлено уведомление "AI детект: требуется решение"
    And должны быть предоставлены кнопки для ручного решения
    And AI детект должен быть выключен после анализа

  @ai_detection_clean_message
  Scenario: AI детект определяет чистое сообщение
    Given AI детект включен для подозрительного пользователя
    And пользователь отправляет чистое сообщение
    When система выполняет AI анализ
    Then AI должен определить низкую вероятность спама (<0.3)
    And сообщение должно быть разрешено
    And должно быть только логирование без уведомлений
    And AI детект должен быть выключен после анализа

  @suspicious_user_manual_approval
  Scenario: Ручное одобрение подозрительного пользователя администратором
    Given пользователь помечен как подозрительный
    And администратор нажимает кнопку "Одобрить"
    When система обрабатывает ручное одобрение
    Then пользователь должен быть одобрен
    And пользователь должен быть удален из списка подозрительных
    And счетчики сообщений должны быть очищены
    And предупреждения должны быть удалены

  @suspicious_user_manual_ban
  Scenario: Ручной бан подозрительного пользователя администратором
    Given пользователь помечен как подозрительный
    And администратор нажимает кнопку "Забанить"
    When система обрабатывает ручной бан
    Then пользователь должен быть забанен
    And пользователь должен быть удален из списка подозрительных
    And все данные пользователя должны быть очищены

  @suspicious_user_stats
  Scenario: Статистика подозрительных пользователей
    Given в системе есть несколько подозрительных пользователей
    When администратор запрашивает статистику
    Then должна быть показана общая статистика
    And должно быть указано количество подозрительных пользователей
    And должно быть указано количество пользователей с AI детектом
    And должна быть показана статистика по чатам

  @suspicious_user_list
  Scenario: Список подозрительных пользователей
    Given в системе есть подозрительные пользователи
    When администратор запрашивает список
    Then должен быть показан список всех подозрительных пользователей
    And для каждого пользователя должна быть показана информация
    And должна быть указана дата обнаружения
    And должна быть показана оценка мимикрии
    And должно быть указано количество сообщений с момента обнаружения

  @suspicious_detection_disabled
  Scenario: Система обнаружения подозрительных отключена
    Given система обнаружения подозрительных отключена
    When пользователь отправляет первые 3 сообщения
    Then анализ мимикрии не должен выполняться
    And пользователь должен быть одобрен по обычным правилам
    And пользователь не должен быть помечен как подозрительный

  @mimicry_analysis_error
  Scenario: Ошибка при анализе мимикрии
    Given пользователь отправляет первые 3 сообщения
    And система анализа мимикрии недоступна
    When система пытается проанализировать мимикрию
    Then ошибка должна быть залогирована
    And пользователь должен быть одобрен по обычным правилам
    And пользователь не должен быть помечен как подозрительный

  @suspicious_user_cleanup
  Scenario: Очистка данных подозрительного пользователя
    Given пользователь помечен как подозрительный
    And пользователь покидает чат
    When система выполняет очистку данных
    Then пользователь должен быть удален из списка подозрительных
    And все связанные данные должны быть очищены
    And счетчики сообщений должны быть сброшены 