# Система одобрения пользователей ClubDoorman

## Обзор

ClubDoorman теперь поддерживает две системы одобрения пользователей:

1. **Старая система** - глобальное одобрение (как было раньше)
2. **Новая система** - поддержка глобального и группового одобрения

## Настройка через переменные окружения

### DOORMAN_USE_NEW_APPROVAL_SYSTEM
- **Значение**: `true` или `false` (по умолчанию `false`)
- **Описание**: Включает новую систему одобрения
- **Пример**: `DOORMAN_USE_NEW_APPROVAL_SYSTEM=true`

### DOORMAN_GROUP_APPROVAL_MODE
- **Значение**: `true` или `false` (по умолчанию `false`)
- **Описание**: Включает групповой режим одобрения (работает только с новой системой)
- **Пример**: `DOORMAN_GROUP_APPROVAL_MODE=true`

## Режимы работы

### Старая система (по умолчанию)
```
DOORMAN_USE_NEW_APPROVAL_SYSTEM=false
```

- Все одобрения глобальные
- Пользователь одобряется во всех группах сразу
- Файл данных: `data/approved_users.json`

### Новая система - глобальный режим
```
DOORMAN_USE_NEW_APPROVAL_SYSTEM=true
DOORMAN_GROUP_APPROVAL_MODE=false
```

- Пользователь одобряется глобально после 3 сообщений в любых группах
- Одобрение действует во всех группах
- Файлы данных: `data/approved_users.json` (глобальные одобрения)

### Новая система - групповой режим
```
DOORMAN_USE_NEW_APPROVAL_SYSTEM=true
DOORMAN_GROUP_APPROVAL_MODE=true
```

- Пользователь одобряется отдельно в каждой группе
- Нужно 3 сообщения в каждой группе для одобрения в этой группе
- Файлы данных: `data/approved_users_groups.json` (групповые одобрения)

## Структура данных новой системы

### Файл approved_users.json (глобальные одобрения)

Простой массив ID пользователей (совместим с оригинальным форматом):

```json
[
  123456789,
  987654321,
  555666777
]
```

### Файл approved_users_groups.json (групповые одобрения)

Структура с группами и датами одобрения:

```json
{
  "-1001234567890": {
    "123456789": {
      "ApprovedAt": "2024-01-01T12:00:00Z"
    },
    "555666777": {
      "ApprovedAt": "2024-01-01T14:30:00Z"
    }
  },
  "-1009876543210": {
    "987654321": {
      "ApprovedAt": "2024-01-01T13:00:00Z"
    }
  }
}
```

### Разделение файлов:
- **approved_users.json**: Глобальные одобрения (формат как в старой системе)
- **approved_users_groups.json**: Групповые одобрения с датами
  - Ключ верхнего уровня: ID группы
  - Ключ второго уровня: ID пользователя
  - Значение: Объект с датой одобрения

## Логика проверки одобрения

В новой системе проверка одобрения работает следующим образом:

1. **Сначала проверяется глобальное одобрение**
   - Если пользователь одобрен глобально → доступ разрешен

2. **Затем проверяется групповое одобрение** (если указан ID группы)
   - Если пользователь одобрен в конкретной группе → доступ разрешен

3. **Если ни одно условие не выполнено** → доступ запрещен

## Автоодобрение

### Глобальный режим
- Счетчик хороших сообщений ведется глобально
- После 3 сообщений в любых группах → глобальное одобрение

### Групповой режим  
- Счетчик хороших сообщений ведется отдельно для каждой группы
- После 3 сообщений в конкретной группе → одобрение в этой группе

## Миграция данных

При переходе на новую систему:

1. **Глобальный режим**: Существующий файл `data/approved_users.json` используется как есть
2. **Групповой режим**: Создается новый файл `data/approved_users_groups.json`
3. **Обратная совместимость**: Формат `approved_users.json` остается неизменным
4. **Автоматическая миграция**: Новая система может читать старый формат файла (поддерживает и `List<long>` и `Dictionary<long, DateTime>`)

## Административные команды

### Одобрение через админ-бота
- Команда `approve_<user_id>` всегда создает глобальное одобрение
- Независимо от настроек системы

### Удаление одобрения
При бане пользователя:
- В старой системе: удаляется глобальное одобрение  
- В новой системе: удаляются все одобрения (глобальное + все групповые)

## Примеры использования

### Пример 1: Клуб с несколькими группами
```bash
# Глобальное одобрение - пользователь одобрен во всех группах
DOORMAN_USE_NEW_APPROVAL_SYSTEM=true
DOORMAN_GROUP_APPROVAL_MODE=false
```

### Пример 2: Независимые группы
```bash
# Групповое одобрение - каждая группа независима
DOORMAN_USE_NEW_APPROVAL_SYSTEM=true
DOORMAN_GROUP_APPROVAL_MODE=true
```

### Пример 3: Обратная совместимость
```bash
# Старая система - как было раньше
DOORMAN_USE_NEW_APPROVAL_SYSTEM=false
```

## Мониторинг

Новая система логирует:
- Режим одобрения пользователей
- Тип одобрения (глобальное/групповое)
- Статистику одобрений

Пример логов:
```
User John Doe behaved well for the last 3 messages, approving globally
User Jane Smith behaved well for the last 3 messages in group My Group, approving in this group
``` 