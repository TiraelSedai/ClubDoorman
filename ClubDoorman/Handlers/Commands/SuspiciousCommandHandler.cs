using ClubDoorman.Infrastructure;
using ClubDoorman.Services;
using Telegram.Bot;
using Telegram.Bot.Types;
using Telegram.Bot.Types.Enums;

namespace ClubDoorman.Handlers.Commands;

/// <summary>
/// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
/// </summary>
public class SuspiciousCommandHandler : ICommandHandler
{
    private readonly TelegramBotClient _bot;
    private readonly IModerationService _moderationService;
    private readonly ILogger<SuspiciousCommandHandler> _logger;

    public string CommandName => "suspicious";

    public SuspiciousCommandHandler(
        TelegramBotClient bot, 
        IModerationService moderationService,
        ILogger<SuspiciousCommandHandler> logger)
    {
        _bot = bot;
        _moderationService = moderationService;
        _logger = logger;
    }

    public async Task HandleAsync(Message message, CancellationToken cancellationToken = default)
    {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –ø—Ä–∏—à–ª–∞ –∏–∑ –∞–¥–º–∏–Ω-—á–∞—Ç–∞
        if (message.Chat.Id != Config.AdminChatId && message.Chat.Id != Config.LogAdminChatId)
            return;

        var commandParts = message.Text?.Split(' ', StringSplitOptions.RemoveEmptyEntries) ?? Array.Empty<string>();
        if (commandParts.Length < 2)
        {
            await ShowHelp(message, cancellationToken);
            return;
        }

        var subCommand = commandParts[1].ToLower();
        
        try
        {
            switch (subCommand)
            {
                case "stats":
                    await HandleStatsCommand(message, cancellationToken);
                    break;
                    
                case "list":
                    await HandleListCommand(message, cancellationToken);
                    break;
                    
                case "help":
                default:
                    await ShowHelp(message, cancellationToken);
                    break;
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã /suspicious {SubCommand}", subCommand);
            await _bot.SendMessage(
                message.Chat.Id,
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã",
                cancellationToken: cancellationToken
            );
        }
    }

    private async Task HandleStatsCommand(Message message, CancellationToken cancellationToken)
    {
        var (totalSuspicious, withAiDetect, groupsCount) = _moderationService.GetSuspiciousUsersStats();

        var statsText = $"üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π*\n\n" +
                       $"üë• –í—Å–µ–≥–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö: *{totalSuspicious}*\n" +
                       $"üîç –° –≤–∫–ª—é—á–µ–Ω–Ω—ã–º AI –¥–µ—Ç–µ–∫—Ç–æ–º: *{withAiDetect}*\n" +
                       $"üè† –ó–∞—Ç—Ä–æ–Ω—É—Ç–æ –≥—Ä—É–ø–ø: *{groupsCount}*\n\n" +
                       $"‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏:\n" +
                       $"‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–µ–Ω–∞: {(Config.SuspiciousDetectionEnabled ? "‚úÖ" : "‚ùå")}\n" +
                       $"‚Ä¢ –ü–æ—Ä–æ–≥ –º–∏–º–∏–∫—Ä–∏–∏: *{Config.MimicryThreshold:F1}*\n" +
                       $"‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–∏—è: *{Config.SuspiciousToApprovedMessageCount}*";

        await _bot.SendMessage(
            message.Chat.Id,
            statsText,
            parseMode: ParseMode.Markdown,
            cancellationToken: cancellationToken
        );

        _logger.LogInformation("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∞–¥–º–∏–Ω-—á–∞—Ç");
    }

    private async Task HandleListCommand(Message message, CancellationToken cancellationToken)
    {
        var aiDetectUsers = _moderationService.GetAiDetectUsers();

        if (aiDetectUsers.Count == 0)
        {
            await _bot.SendMessage(
                message.Chat.Id,
                "üìù *–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å AI –¥–µ—Ç–µ–∫—Ç–æ–º*\n\n" +
                "–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º AI –¥–µ—Ç–µ–∫—Ç–æ–º.",
                parseMode: ParseMode.Markdown,
                cancellationToken: cancellationToken
            );
            return;
        }

        var listText = $"üìù *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º AI –¥–µ—Ç–µ–∫—Ç–æ–º* ({aiDetectUsers.Count})\n\n";

        for (int i = 0; i < Math.Min(aiDetectUsers.Count, 10); i++) // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º 10
        {
            var (userId, chatId) = aiDetectUsers[i];
            listText += $"{i + 1}. ID: `{userId}` –≤ —á–∞—Ç–µ `{chatId}`\n";
        }

        if (aiDetectUsers.Count > 10)
        {
            listText += $"\n... –∏ –µ—â—ë {aiDetectUsers.Count - 10} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π";
        }

        await _bot.SendMessage(
            message.Chat.Id,
            listText,
            parseMode: ParseMode.Markdown,
            cancellationToken: cancellationToken
        );

        _logger.LogInformation("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å AI –¥–µ—Ç–µ–∫—Ç–æ–º –≤ –∞–¥–º–∏–Ω-—á–∞—Ç");
    }

    private async Task ShowHelp(Message message, CancellationToken cancellationToken)
    {
        var helpText = """
üîç *–ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏*

/suspicious stats - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
/suspicious list - —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å AI –¥–µ—Ç–µ–∫—Ç–æ–º  
/suspicious help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

*–û–ø–∏—Å–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:*
–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–µ—Ä–≤—ã–µ 3 —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —à–∞–±–ª–æ–Ω–Ω–æ—Å—Ç–∏ –∏ –º–∏–º–∏–∫—Ä–∏–∏. –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–≤–æ–¥—è—Ç—Å—è –≤ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å –∏ —Ç—Ä–µ–±—É—é—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ö–æ—Ä–æ—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–∏—è.

–î–ª—è –æ—Å–æ–±–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –≤–∫–ª—é—á–∏—Ç—å AI –¥–µ—Ç–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å –≤—Å–µ –∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω-—á–∞—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
""";

        await _bot.SendMessage(
            message.Chat.Id,
            helpText,
            parseMode: ParseMode.Markdown,
            cancellationToken: cancellationToken
        );
    }
} 