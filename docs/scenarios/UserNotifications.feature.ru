# language: ru
@ignore
Feature: Уведомления пользователей и администраторов
  Как модератор чата
  Я хочу получать уведомления о подозрительной активности и предупреждать пользователей
  Чтобы поддерживать качество общения и информировать о правилах

  Background:
    Given система уведомлений инициализирована
    And пользователь с ID 123456789 не одобрен в чате

  @new_user_warning
  Scenario: Предупреждение нового пользователя о правилах
    Given неодобренный пользователь отправляет первое сообщение
    When система обрабатывает сообщение
    Then пользователь должен получить предупреждение о правилах
    And предупреждение должно содержать "вы пока новичок в этом чате"
    And предупреждение должно содержать "первые 3 сообщения проходят антиспам-проверку"
    And предупреждение должно содержать "нельзя эмодзи, рекламу и стоп-слова"
    And предупреждение должно содержать "работает ML-анализ"
    And предупреждение должно быть удалено через 40 секунд
    And повторное предупреждение не должно отправляться в течение 10 минут

  @admin_notification_deleted_message
  Scenario: Уведомление администраторов об удаленном сообщении
    Given сообщение пользователя удаляется системой модерации
    When система отправляет уведомление администраторам
    Then сообщение должно быть переслано в админ-чат
    And должно быть отправлено уведомление с информацией о пользователе
    And уведомление должно содержать ссылку на сообщение
    And должны быть предоставлены кнопки "бан", "пропуск", "свой"
    And уведомление должно содержать причину удаления

  @admin_notification_suspicious_message
  Scenario: Уведомление о подозрительном сообщении без удаления
    Given сообщение пользователя помечено как подозрительное
    When система отправляет уведомление администраторам
    Then сообщение должно быть переслано в админ-чат
    And должно быть отправлено уведомление "Подозрительное сообщение - требует ручной проверки"
    And уведомление должно содержать "Сообщение НЕ удалено"
    And администраторы должны принять решение о дальнейших действиях

  @ai_detection_notification
  Scenario: Уведомление о срабатывании AI детекта
    Given AI система обнаруживает подозрительное сообщение
    When система отправляет уведомление о AI детекте
    Then должно быть отправлено уведомление "AI детект: автоудаление спама"
    And уведомление должно содержать информацию о пользователе
    And уведомление должно содержать текст сообщения
    And уведомление должно содержать AI вероятность спама
    And уведомление должно содержать ML скор
    And должно быть указано "Автоматически удалено"

  @ai_detection_uncertain
  Scenario: Уведомление о неопределенном результате AI детекта
    Given AI система не уверена в результате анализа
    When система отправляет уведомление о неопределенном результате
    Then должно быть отправлено уведомление "AI детект: требуется решение"
    And уведомление должно содержать "AI не уверен - требуется ручное решение"
    And должны быть предоставлены кнопки "Не спам" и "Удалить как спам"
    And пользователь должен быть ограничен на 2 часа
    And уведомление должно содержать все детали анализа

  @suspicious_user_notification
  Scenario: Уведомление о подозрительном пользователе
    Given система обнаруживает подозрительного пользователя
    When система отправляет уведомление о подозрительном пользователе
    Then должно быть отправлено уведомление "Подозрительный пользователь обнаружен"
    And уведомление должно содержать информацию о пользователе
    And уведомление должно содержать оценку мимикрии
    And уведомление должно содержать первые сообщения пользователя
    And должно быть указано количество сообщений для одобрения
    And должны быть предоставлены кнопки "Одобрить", "Забанить", "AI анализ вкл/выкл"

  @blacklist_ban_notification
  Scenario: Уведомление о бане по блэклисту
    Given пользователь из блэклиста отправляет сообщение
    When система выполняет автобан по блэклисту
    Then сообщение должно быть переслано в лог-чат
    And должно быть отправлено уведомление "Автобан по блэклисту lols.bot"
    And уведомление должно содержать информацию о пользователе
    And уведомление должно содержать название чата
    And уведомление должно содержать ссылку на сообщение
    And пользователь должен быть забанен на 4 часа

  @long_name_ban_notification
  Scenario: Уведомление о бане за длинное имя
    Given пользователь с длинным именем присоединяется к чату
    When система банит пользователя за длинное имя
    Then должно быть отправлено уведомление в админ-чат
    And уведомление должно содержать "Бан за длинное имя"
    And уведомление должно содержать полное имя пользователя
    And уведомление должно содержать длину имени
    And уведомление должно содержать тип бана (перманентный или временный)
    And должна быть указана причина бана

  @admin_callback_notification
  Scenario: Обработка админских callback уведомлений
    Given администратор нажимает кнопку в уведомлении
    When система обрабатывает админский callback
    Then должно быть выполнено соответствующее действие
    And результат действия должен быть залогирован
    And пользователь должен получить соответствующее уведомление
    And статус пользователя должен быть обновлен

  @error_notification
  Scenario: Уведомление об ошибках системы
    Given происходит ошибка в системе модерации
    When система отправляет уведомление об ошибке
    Then ошибка должна быть залогирована
    And администраторы должны быть уведомлены о критических ошибках
    And уведомление должно содержать описание ошибки
    And уведомление должно содержать контекст ошибки

  @warning_spam_prevention
  Scenario: Предотвращение спама предупреждениями
    Given пользователь уже получил предупреждение недавно
    When пользователь отправляет еще одно сообщение
    Then повторное предупреждение не должно отправляться
    And система должна залогировать "предупреждение уже было отправлено недавно"
    And кэш предупреждений должен быть обновлен

  @notification_formatting
  Scenario: Форматирование уведомлений
    Given система отправляет уведомление администраторам
    When уведомление форматируется
    Then имя пользователя должно быть в формате ссылки
    And название чата должно быть выделено
    And ссылка на сообщение должна быть корректной
    And кнопки должны иметь правильные callback данные
    And текст должен быть экранирован для Markdown

  @log_chat_notification
  Scenario: Уведомления в лог-чат
    Given настроен отдельный лог-чат для автобанов
    When происходит автобан пользователя
    Then уведомление должно быть отправлено в лог-чат
    And основная админ-группа не должна получать уведомление
    And лог-чат должен содержать полную информацию о бане
    And должна быть ссылка на оригинальное сообщение 