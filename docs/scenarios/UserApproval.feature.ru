# language: ru
@ignore
Feature: Система одобрения пользователей
  Как модератор чата
  Я хочу автоматически одобрять пользователей после хорошего поведения
  Чтобы снизить нагрузку на модерацию

  Background:
    Given система модобрения инициализирована
    And пользователь с ID 123456789 не одобрен в чате

  @old_approval_system
  Scenario: Старая система - глобальное одобрение после 3 сообщений
    Given включена старая система одобрения
    And пользователь с ID 123456789 отправляет первое хорошее сообщение "Привет всем!"
    When система обрабатывает сообщение
    Then счетчик хороших сообщений должен быть 1
    And пользователь не должен быть одобрен

    Given пользователь отправляет второе хорошее сообщение "Как дела у всех?"
    When система обрабатывает сообщение
    Then счетчик хороших сообщений должен быть 2
    And пользователь не должен быть одобрен

    Given пользователь отправляет третье хорошее сообщение "Отличная группа!"
    When система обрабатывает сообщение
    Then пользователь должен быть одобрен глобально
    And счетчик хороших сообщений должен быть сброшен

  @new_approval_system_global
  Scenario: Новая система - глобальный режим одобрения
    Given включена новая система одобрения
    And включен глобальный режим одобрения
    And пользователь с ID 123456789 отправляет первое хорошее сообщение "Привет всем!"
    When система обрабатывает сообщение
    Then счетчик хороших сообщений должен быть 1
    And пользователь не должен быть одобрен

    Given пользователь отправляет второе хорошее сообщение "Как дела у всех?"
    When система обрабатывает сообщение
    Then счетчик хороших сообщений должен быть 2
    And пользователь не должен быть одобрен

    Given пользователь отправляет третье хорошее сообщение "Отличная группа!"
    When система обрабатывает сообщение
    Then пользователь должен быть одобрен глобально
    And счетчик хороших сообщений должен быть сброшен

  @new_approval_system_group
  Scenario: Новая система - групповой режим одобрения
    Given включена новая система одобрения
    And включен групповой режим одобрения
    And пользователь с ID 123456789 отправляет первое хорошее сообщение "Привет всем!"
    When система обрабатывает сообщение
    Then счетчик хороших сообщений должен быть 1
    And пользователь не должен быть одобрен в чате

    Given пользователь отправляет второе хорошее сообщение "Как дела у всех?"
    When система обрабатывает сообщение
    Then счетчик хороших сообщений должен быть 2
    And пользователь не должен быть одобрен в чате

    Given пользователь отправляет третье хорошее сообщение "Отличная группа!"
    When система обрабатывает сообщение
    Then пользователь должен быть одобрен только в этом чате
    And счетчик хороших сообщений должен быть сброшен

  @suspicious_detection_enabled
  Scenario: Система подозрительных пользователей включена
    Given включена система детекции подозрительных пользователей
    And порог мимикрии установлен в 0.7
    And пользователь с ID 123456789 отправляет первое сообщение "Привет"
    When система обрабатывает сообщение
    Then сообщение должно быть сохранено для анализа мимикрии

    Given пользователь отправляет второе сообщение "Как дела"
    When система обрабатывает сообщение
    Then сообщение должно быть сохранено для анализа мимикрии

    Given пользователь отправляет третье сообщение "?"
    When система обрабатывает сообщение
    Then должен быть выполнен анализ мимикрии
    And если скор мимикрии >= 0.7, пользователь должен быть помечен как подозрительный

  @suspicious_user_detected
  Scenario: Пользователь помечен как подозрительный
    Given пользователь с ID 123456789 помечен как подозрительный
    And скор мимикрии составляет 0.85
    And первые сообщения: "Привет", "Как дела", "?"
    When пользователь отправляет хорошее сообщение "Спасибо за информацию"
    Then счетчик сообщений подозрительного пользователя должен увеличиться
    And уведомление должно быть отправлено админам
    And должны быть показаны кнопки "Одобрить", "Забанить", "AI анализ вкл/выкл"

  @suspicious_to_approved
  Scenario: Подозрительный пользователь становится одобренным
    Given пользователь с ID 123456789 помечен как подозрительный
    And требуется 3 дополнительных сообщения для одобрения
    And пользователь уже отправил 2 хороших сообщения
    When пользователь отправляет третье хорошее сообщение "Отличная группа!"
    Then пользователь должен быть переведен из подозрительных в одобренные
    And счетчик подозрительных сообщений должен быть сброшен
    And пользователь должен быть одобрен в чате

  @ai_detect_enabled
  Scenario: AI детект включен для подозрительного пользователя
    Given пользователь с ID 123456789 помечен как подозрительный
    And AI детект включен для этого пользователя
    When пользователь отправляет сообщение "Купите наш товар прямо сейчас!"
    Then должен быть выполнен специальный AI анализ
    And AI детект должен быть выключен после анализа

  @ai_detect_definite_spam
  Scenario: AI детект - определенный спам
    Given пользователь с ID 123456789 помечен как подозрительный
    And AI детект включен для этого пользователя
    And AI анализ возвращает вероятность спама 0.9
    And ML классификатор возвращает скор 1.8
    When пользователь отправляет сообщение "Купите наш товар прямо сейчас!"
    Then сообщение должно быть автоматически удалено
    And пользователь должен быть ограничен на 2 часа
    And уведомление должно быть отправлено в админ-чат
    And должны быть показаны кнопки "Разблокировать", "Забанить навсегда"

  @ai_detect_uncertain
  Scenario: AI детект - неопределенный результат
    Given пользователь с ID 123456789 помечен как подозрительный
    And AI детект включен для этого пользователя
    And AI анализ возвращает вероятность спама 0.6
    And ML классификатор возвращает скор 0.1
    When пользователь отправляет сообщение "Интересная информация"
    Then пользователь должен быть ограничен на 2 часа
    And оригинальное сообщение должно быть переслано в админ-чат
    And уведомление должно быть отправлено с кнопками "Разблокировать", "Удалить + бан"

  @ai_detect_clean
  Scenario: AI детект - чистое сообщение
    Given пользователь с ID 123456789 помечен как подозрительный
    And AI детект включен для этого пользователя
    And AI анализ возвращает вероятность спама 0.1
    And ML классификатор возвращает скор -1.5
    When пользователь отправляет сообщение "Спасибо за информацию"
    Then сообщение должно быть разрешено
    And пользователь не должен быть ограничен
    And уведомление не должно быть отправлено в админ-чат

  @ai_detect_media_ignored
  Scenario: AI детект игнорирует медиа сообщения
    Given пользователь с ID 123456789 помечен как подозрительный
    And AI детект включен для этого пользователя
    When пользователь отправляет фото без подписи
    Then AI анализ не должен выполняться
    And AI детект должен остаться включенным

  @suspicious_user_approve_button
  Scenario: Кнопка одобрения подозрительного пользователя
    Given пользователь с ID 123456789 помечен как подозрительный
    When админ нажимает кнопку "Одобрить"
    Then пользователь должен быть переведен из подозрительных в одобренные
    And все ограничения должны быть сняты
    And пользователь должен быть одобрен в чате

  @suspicious_user_ban_button
  Scenario: Кнопка бана подозрительного пользователя
    Given пользователь с ID 123456789 помечен как подозрительный
    When админ нажимает кнопку "Забанить"
    Then пользователь должен быть забанен
    And пользователь должен быть удален из всех списков

  @suspicious_user_ai_toggle
  Scenario: Переключение AI детекта для подозрительного пользователя
    Given пользователь с ID 123456789 помечен как подозрительный
    And AI детект выключен
    When админ нажимает кнопку "AI анализ вкл/выкл"
    Then AI детект должен быть включен

    Given AI детект включен
    When админ нажимает кнопку "AI анализ вкл/выкл"
    Then AI детект должен быть выключен

  @mimicry_analysis
  Scenario: Анализ мимикрии первых сообщений
    Given включена система детекции подозрительных пользователей
    And пользователь с ID 123456789 отправляет сообщения: "Привет", "Как дела", "?"
    When система анализирует мимикрию
    Then должен быть рассчитан скор мимикрии
    And если скор >= 0.7, пользователь должен быть помечен как подозрительный

  @mimicry_analysis_insufficient_messages
  Scenario: Анализ мимикрии с недостаточным количеством сообщений
    Given включена система детекции подозрительных пользователей
    And пользователь с ID 123456789 отправил только 2 сообщения
    When система пытается проанализировать мимикрию
    Then анализ не должен выполняться
    And пользователь не должен быть помечен как подозрительный

  @suspicious_stats
  Scenario: Статистика подозрительных пользователей
    Given в системе есть 5 подозрительных пользователей
    And у 2 из них включен AI детект
    And пользователи находятся в 3 разных группах
    When запрашивается статистика подозрительных пользователей
    Then должно быть возвращено: TotalSuspicious=5, WithAiDetect=2, GroupsCount=3

  @ai_detect_users_list
  Scenario: Список пользователей с AI детектом
    Given в системе есть пользователи с включенным AI детектом
    When запрашивается список пользователей с AI детектом
    Then должен быть возвращен список пар (UserId, ChatId)

  @suspicious_user_cleanup
  Scenario: Очистка подозрительного пользователя из всех списков
    Given пользователь с ID 123456789 помечен как подозрительный
    And пользователь одобрен в чате
    And у пользователя есть счетчики сообщений
    When выполняется полная очистка пользователя
    Then пользователь должен быть удален из списка подозрительных
    And пользователь должен быть удален из списка одобренных
    And все счетчики сообщений должны быть сброшены
    And все кэши должны быть очищены

  @suspicious_detection_disabled
  Scenario: Система подозрительных пользователей отключена
    Given система детекции подозрительных пользователей отключена
    And пользователь с ID 123456789 отправляет 3 сообщения
    When система обрабатывает сообщения
    Then анализ мимикрии не должен выполняться
    And пользователь должен быть одобрен обычным способом

  @null_user_approval
  Scenario: Попытка одобрения null пользователя
    Given null пользователь
    When система пытается обработать сообщение
    Then должно быть выброшено исключение ArgumentNullException
    And сообщение исключения должно содержать "Пользователь не может быть null"

  @null_chat_approval
  Scenario: Попытка одобрения в null чате
    Given пользователь с ID 123456789
    And null чат
    When система пытается обработать сообщение
    Then должно быть выброшено исключение ArgumentNullException
    And сообщение исключения должно содержать "Чат не может быть null"

  @empty_message_text
  Scenario: Попытка обработки пустого текста сообщения
    Given пользователь с ID 123456789
    And чат с ID 987654321
    And пустой текст сообщения
    When система пытается обработать сообщение
    Then должно быть выброшено исключение ArgumentException
    And сообщение исключения должно содержать "Текст сообщения не может быть пустым" 