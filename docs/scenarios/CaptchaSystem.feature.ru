# language: ru
@ignore
Feature: Система капчи для новых пользователей
  Как модератор чата
  Я хочу чтобы новые пользователи проходили капчу для подтверждения человечности
  Чтобы предотвратить вход ботов и спамеров

  Background:
    Given система капчи инициализирована
    And пользователь с ID 123456789 присоединяется к чату

  @captcha_creation
  Scenario: Создание капчи для нового пользователя
    Given новый пользователь с именем "Александр" и фамилией "Иванов" присоединяется к чату
    When система создает капчу для пользователя
    Then должна быть создана капча с 8 кнопками
    And одна из кнопок должна содержать правильный ответ
    And капча должна содержать приветственное сообщение
    And капча должна быть привязана к сообщению о входе пользователя
    And таймер автоматического удаления капчи должен быть запущен на 1.2 минуты

  @captcha_success
  Scenario: Успешное прохождение капчи
    Given пользователь с ID 123456789 проходит капчу
    When пользователь нажимает правильную кнопку капчи
    Then капча должна быть удалена
    And пользователь должен получить приветственное сообщение
    And приветственное сообщение должно содержать правила чата
    And приветственное сообщение должно быть удалено через 20 секунд
    And пользователь должен получить доступ к отправке сообщений

  @captcha_failure
  Scenario: Неудачное прохождение капчи
    Given пользователь с ID 123456789 проходит капчу
    When пользователь нажимает неправильную кнопку капчи
    Then капча должна быть удалена
    And пользователь должен быть забанен на 20 минут
    And сообщение о входе пользователя должно быть удалено
    And разбан должен быть запланирован через 20 минут
    And статистика капчи должна быть увеличена

  @captcha_timeout
  Scenario: Таймаут капчи
    Given пользователь с ID 123456789 проходит капчу
    When проходит 1.3 минуты без ответа на капчу
    Then капча должна быть автоматически удалена
    And пользователь должен быть забанен на 20 минут
    And сообщение о входе пользователя должно быть удалено
    And разбан должен быть запланирован через 20 минут
    And в логах должно быть зафиксировано "не прошёл капчу (таймаут)"

  @captcha_blacklist_name
  Scenario: Скрытие имени пользователя с запрещенными словами
    Given пользователь с именем "porn_user" присоединяется к чату
    When система создает капчу для пользователя
    Then в приветственном сообщении должно быть "новый участник чата"
    And реальное имя пользователя не должно отображаться

  @captcha_no_ad_group
  Scenario: Капча в группе без рекламы
    Given чат настроен как группа без рекламы VPN
    And новый пользователь присоединяется к чату
    When система создает капчу для пользователя
    Then приветственное сообщение не должно содержать "Место для рекламы"

  @captcha_with_ad
  Scenario: Капча в обычной группе с рекламой
    Given чат не настроен как группа без рекламы VPN
    And новый пользователь присоединяется к чату
    When система создает капчу для пользователя
    Then приветственное сообщение должно содержать "Место для рекламы"

  @captcha_duplicate_prevention
  Scenario: Предотвращение дублирования капчи
    Given пользователь с ID 123456789 уже проходит капчу
    When пользователь пытается отправить сообщение
    Then сообщение должно быть удалено
    And система должна показать предупреждение "пользователь уже проходит капчу"

  @captcha_callback_security
  Scenario: Безопасность callback капчи
    Given пользователь с ID 123456789 проходит капчу
    When другой пользователь пытается ответить на капчу
    Then callback должен быть проигнорирован
    And капча должна остаться активной

  @captcha_announcement_chat
  Scenario: Капча в чате-объявлениях
    Given чат настроен как чат-объявления
    And новый пользователь присоединяется к чату
    When пользователь успешно проходит капчу
    Then приветственное сообщение должно содержать "первые три сообщения проходят антиспам-проверку"
    And должно быть упомянуто про стоп-слова и спам

  @captcha_regular_chat
  Scenario: Капча в обычном чате
    Given чат не настроен как чат-объявления
    And новый пользователь присоединяется к чату
    When пользователь успешно проходит капчу
    Then приветственное сообщение должно содержать "эмодзи, изображения, стикеры, документы и реклама запрещены"
    And должно быть упомянуто про антиспам-проверку

  @captcha_error_handling
  Scenario: Обработка ошибок при создании капчи
    Given система капчи инициализирована
    When происходит ошибка при отправке капчи
    Then ошибка должна быть залогирована
    And исключение должно быть выброшено
    And пользователь не должен получить доступ к чату

  @captcha_cleanup
  Scenario: Очистка просроченных капч
    Given несколько пользователей не прошли капчу вовремя
    When система выполняет очистку просроченных капч
    Then все просроченные капчи должны быть удалены
    And соответствующие пользователи должны быть забанены
    And разбаны должны быть запланированы 