# Каскадная система отслеживания нарушений - Gherkin описание

## Обзор системы

Каскадная система отслеживания нарушений автоматически банит пользователей за повторные нарушения правил чата. Система работает по принципу "трех ударов" - после определенного количества нарушений одного типа пользователь получает автоматический бан.

## Основные сценарии

### Feature: Отслеживание нарушений ML фильтра

**Как** модератор чата  
**Я хочу** чтобы система автоматически отслеживала нарушения ML фильтра  
**Чтобы** банить пользователей за повторные спам-сообщения  

#### Scenario: Первое нарушение ML фильтра
```
Given пользователь отправляет сообщение с ML-спамом
When система определяет сообщение как спам через ML фильтр
And система удаляет сообщение
Then система регистрирует нарушение типа "ML спам"
And счетчик нарушений ML спама увеличивается до 1
And пользователь НЕ получает бан
And система отправляет уведомление в лог-чат
```

#### Scenario: Достижение лимита нарушений ML фильтра
```
Given пользователь уже имеет 2 нарушения ML спама
When пользователь отправляет третье сообщение с ML-спамом
And система определяет сообщение как спам через ML фильтр
Then система регистрирует третье нарушение типа "ML спам"
And счетчик нарушений ML спама достигает лимита (3)
And система автоматически банит пользователя
And система удаляет сообщение
And система отправляет уведомление о бане за повторные нарушения
And все счетчики нарушений пользователя сбрасываются
```

### Feature: Отслеживание нарушений стоп-слов

**Как** модератор чата  
**Я хочу** чтобы система отслеживала использование запрещенных слов  
**Чтобы** банить пользователей за повторное использование стоп-слов  

#### Scenario: Первое нарушение стоп-слов
```
Given пользователь отправляет сообщение со стоп-словами
When система определяет сообщение как содержащее стоп-слова
And система удаляет сообщение
Then система регистрирует нарушение типа "стоп-слова"
And счетчик нарушений стоп-слов увеличивается до 1
And пользователь НЕ получает бан
And система отправляет уведомление в лог-чат
```

#### Scenario: Достижение лимита нарушений стоп-слов
```
Given пользователь уже имеет 2 нарушения стоп-слов
When пользователь отправляет третье сообщение со стоп-словами
And система определяет сообщение как содержащее стоп-слова
Then система регистрирует третье нарушение типа "стоп-слова"
And счетчик нарушений стоп-слов достигает лимита (3)
And система автоматически банит пользователя
And система удаляет сообщение
And система отправляет уведомление о бане за повторные нарушения
And все счетчики нарушений пользователя сбрасываются
```

### Feature: Отслеживание нарушений эмодзи

**Как** модератор чата  
**Я хочу** чтобы система отслеживала избыточное использование эмодзи  
**Чтобы** банить пользователей за повторное злоупотребление эмодзи  

#### Scenario: Первое нарушение эмодзи
```
Given пользователь отправляет сообщение с избыточными эмодзи
When система определяет сообщение как содержащее слишком много эмодзи
And система удаляет сообщение
Then система регистрирует нарушение типа "много эмодзи"
And счетчик нарушений эмодзи увеличивается до 1
And пользователь НЕ получает бан
And система отправляет уведомление в лог-чат
```

#### Scenario: Достижение лимита нарушений эмодзи
```
Given пользователь уже имеет 2 нарушения эмодзи
When пользователь отправляет третье сообщение с избыточными эмодзи
And система определяет сообщение как содержащее слишком много эмодзи
Then система регистрирует третье нарушение типа "много эмодзи"
And счетчик нарушений эмодзи достигает лимита (3)
And система автоматически банит пользователя
And система удаляет сообщение
And система отправляет уведомление о бане за повторные нарушения
And все счетчики нарушений пользователя сбрасываются
```

### Feature: Отслеживание lookalike символов

**Как** модератор чата  
**Я хочу** чтобы система отслеживала использование похожих символов  
**Чтобы** банить пользователей за повторное использование lookalike символов  

#### Scenario: Первое нарушение lookalike символов
```
Given пользователь отправляет сообщение с lookalike символами
When система определяет сообщение как содержащее lookalike символы
And система удаляет сообщение
Then система регистрирует нарушение типа "lookalike символы"
And счетчик нарушений lookalike символов увеличивается до 1
And пользователь НЕ получает бан
And система отправляет уведомление в лог-чат
```

#### Scenario: Достижение лимита нарушений lookalike символов
```
Given пользователь уже имеет 2 нарушения lookalike символов
When пользователь отправляет третье сообщение с lookalike символами
And система определяет сообщение как содержащее lookalike символы
Then система регистрирует третье нарушение типа "lookalike символы"
And счетчик нарушений lookalike символов достигает лимита (3)
And система автоматически банит пользователя
And система удаляет сообщение
And система отправляет уведомление о бане за повторные нарушения
And все счетчики нарушений пользователя сбрасываются
```

## Конфигурация системы

### Feature: Настройка лимитов нарушений

**Как** администратор системы  
**Я хочу** настраивать лимиты нарушений для разных типов  
**Чтобы** адаптировать систему под потребности конкретного чата  

#### Scenario: Настройка лимитов через переменные окружения
```
Given администратор настраивает переменные окружения:
  | Тип нарушения | Переменная | Значение |
  | ML спам | DOORMAN__ML_VIOLATIONS_BEFORE_BAN | 3 |
  | Стоп-слова | DOORMAN__STOP_WORDS_VIOLATIONS_BEFORE_BAN | 2 |
  | Эмодзи | DOORMAN__EMOJI_VIOLATIONS_BEFORE_BAN | 4 |
  | Lookalike | DOORMAN__LOOKALIKE_VIOLATIONS_BEFORE_BAN | 3 |
When система запускается
Then система использует настроенные лимиты для каждого типа нарушений
And система отслеживает нарушения согласно установленным лимитам
```

### Feature: Настройка уведомлений о банах

**Как** администратор системы  
**Я хочу** настраивать куда отправляются уведомления о банах  
**Чтобы** контролировать поток уведомлений  

#### Scenario: Отправка уведомлений в админ-чат
```
Given администратор включает DOORMAN__REPEATED_VIOLATIONS_BAN_TO_ADMIN_CHAT=true
When пользователь получает бан за повторные нарушения
Then система отправляет уведомление в админ-чат
And система НЕ отправляет уведомление в лог-чат
```

#### Scenario: Отправка уведомлений в лог-чат (по умолчанию)
```
Given администратор НЕ настраивает DOORMAN__REPEATED_VIOLATIONS_BAN_TO_ADMIN_CHAT
When пользователь получает бан за повторные нарушения
Then система отправляет уведомление в лог-чат
And система НЕ отправляет уведомление в админ-чат
```

## Технические детали

### Типы нарушений

Система отслеживает 4 типа нарушений:

1. **ML спам** - сообщения, определенные ML фильтром как спам
2. **Стоп-слова** - сообщения, содержащие запрещенные слова
3. **Много эмодзи** - сообщения с избыточным количеством эмодзи
4. **Lookalike символы** - сообщения с символами, похожими на буквы

### Счетчики нарушений

- Каждый тип нарушения имеет отдельный счетчик
- Счетчики хранятся в памяти на 24 часа
- При достижении лимита пользователь получает бан
- После бана все счетчики пользователя сбрасываются

### Автоматический бан

При достижении лимита нарушений система:
1. Автоматически банит пользователя
2. Удаляет последнее нарушившее сообщение
3. Отправляет уведомление о бане
4. Сбрасывает все счетчики нарушений пользователя
5. Очищает пользователя из всех списков модерации

### Уведомления

Система отправляет уведомления с:
- Информацией о пользователе
- Типом нарушения
- Ссылкой на нарушившее сообщение
- Кнопками для действий модератора 