# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ClubDoorman

## –û–±–∑–æ—Ä

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç NUnit –¥–ª—è unit-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ SpecFlow –¥–ª—è BDD —Ç–µ—Å—Ç–æ–≤.

## –ì—Ä—É–ø–ø—ã —Ç–µ—Å—Ç–æ–≤

### üöÄ –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã (Fast Tests)
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: < 1 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Ç–µ—Å—Ç
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **–ó–∞–ø—É—Å–∫**: `./scripts/run-tests.sh fast` –∏–ª–∏ `dotnet test --filter "TestCategory!=slow"`

**–í–∫–ª—é—á–∞—é—Ç:**
- MessageHandler (–æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞)
- CaptchaService (–±–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
- ModerationService (–ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏)
- UserManager (–æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
- –ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞

### üêå –ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (Slow Tests)
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: 10-120 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Ç–µ—Å—Ç
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: ML –º–æ–¥–µ–ª–∏, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã, —Ç—è–∂–µ–ª—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
- **–ó–∞–ø—É—Å–∫**: `./scripts/run-tests.sh slow` –∏–ª–∏ `dotnet test --filter "TestCategory=slow"`

**–í–∫–ª—é—á–∞—é—Ç:**
- SpamHamClassifier (ML –º–æ–¥–µ–ª—å)
- AiChecks (AI –∞–Ω–∞–ª–∏–∑)
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ API
- –¢–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### üìä –í—Å–µ —Ç–µ—Å—Ç—ã (All Tests)
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: 3-5 –º–∏–Ω—É—Ç
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
- **–ó–∞–ø—É—Å–∫**: `./scripts/run-tests.sh all` –∏–ª–∏ `dotnet test`

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
```bash
# –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã - –¥–ª—è –ø—Ä–µ–∫–æ–º–º–∏—Ç–∞
./scripts/run-tests.sh fast

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é
dotnet test --filter "TestCategory!=slow"
```

### –î–ª—è CI/CD
```bash
# –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º
./scripts/run-tests.sh all
```

### –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ ML –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
```bash
# –¢–æ–ª—å–∫–æ ML —Ç–µ—Å—Ç—ã
dotnet test --filter "TestCategory=slow"
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
ClubDoorman.Test/
‚îú‚îÄ‚îÄ Unit/                    # Unit —Ç–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ Handlers/           # –¢–µ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ Services/           # –¢–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ Moderation/         # –¢–µ—Å—Ç—ã –º–æ–¥–µ—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ Integration/            # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ TestInfrastructure/     # –¢–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
‚îî‚îÄ‚îÄ TestData/              # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
```

## –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ—Å—Ç–æ–≤

- `[Category("unit")]` - Unit —Ç–µ—Å—Ç—ã
- `[Category("integration")]` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- `[Category("slow")]` - –ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (ML, AI)
- `[Category("critical")]` - –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- `[Category("handlers")]` - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- `[Category("services")]` - –°–µ—Ä–≤–∏—Å—ã
- `[Category("moderation")]` - –ú–æ–¥–µ—Ä–∞—Ü–∏—è
- `[Category("ml")]` - Machine Learning

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤

### –¢–∞–π–º–∞—É—Ç—ã
–ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –∏–º–µ—é—Ç —Ç–∞–π–º–∞—É—Ç—ã:
```csharp
[Test]
[CancelAfter(10000)] // 10 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
public async Task IsSpam_ValidMessage_ReturnsNotSpam()
```

### –ú–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Moq –¥–ª—è –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
```csharp
var mockLogger = new Mock<ILogger<Service>>();
var service = new Service(mockLogger.Object);
```

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã:
```csharp
var message = MessageTestData.ValidMessage();
var user = TestDataFactory.CreateValidUser();
```

## –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤

### –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥
```bash
dotnet test --verbosity detailed
```

### –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
```bash
dotnet test --filter "TestName=HandleAsync_ValidMessage_ProcessesSuccessfully"
```

### –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
```bash
dotnet test --maxcpucount:4
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- **–ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã**: ~350 —Ç–µ—Å—Ç–æ–≤, < 30 —Å–µ–∫—É–Ω–¥
- **–ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã**: ~14 —Ç–µ—Å—Ç–æ–≤, 2-3 –º–∏–Ω—É—Ç—ã
- **–í—Å–µ —Ç–µ—Å—Ç—ã**: ~364 —Ç–µ—Å—Ç–∞, 3-5 –º–∏–Ω—É—Ç

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–µ–∫–æ–º–º–∏—Ç–∞
2. –ú–µ–¥–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
3. –í CI/CD –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
4. –ö—ç—à–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ML –º–æ–¥–µ–ª–µ–π –≤ —Ç–µ—Å—Ç–∞—Ö

## Troubleshooting

### –¢–µ—Å—Ç—ã –∑–∞–≤–∏—Å–∞—é—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–π–º–∞—É—Ç—ã –≤ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞—Ö
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ML –º–æ–¥–µ–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏—Ö API

### –û—à–∏–±–∫–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `dotnet restore`
- –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à: `dotnet clean`
- –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ: `dotnet build`

### –ü—Ä–æ–±–ª–µ–º—ã —Å ML –º–æ–¥–µ–ª—å—é
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ `data/spam-ham.txt`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `data/exclude-tokens.txt` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –¥–∞–Ω–Ω—ã—Ö 